---
title: "BDA - Assignment 6"
output: 
  pdf_document: 
    toc: yes
    toc_depth: 3
---


```{r setup, include=FALSE}
# This chunk just sets echo = TRUE as default (i.e. print all code)
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo=TRUE, include=FALSE}
# To install aaltobda, see the General information in the assignment.
library(aaltobda)
library(mvtnorm)
#library(markmyassignment)
library(ggplot2)
library(rstan)
library(StanHeaders)
#exercise_path <-
#"https://github.com/avehtari/BDA_course_Aalto/blob/master/exercises/tests/ex4.yml"
#set_assignment(exercise_path)
#mark_my_assignment()
```


## Exercise 1. 
### 1)
```{r}
library(aaltobda)
data("bioassay")
```
We still use the Gaussian Prior for $\alpha$ and $\beta$: $$\mu=[0,10]$$ and $$\Sigma=\left[\begin{matrix}
4& 10\\ 
10& 100
\end{matrix}\right]$$
Here's the code in the stan file "bioassay_model.stan" I used to define the model.

stan code: "    
data {     
int<lower=0> n;    
int<lower=0> deaths[n];    
int<lower=0> number_of_animals[n];   
vector[n] doses;   
vector[2] mu;   
cov_matrix[2] cov_m;   
}   
parameters {   
vector[2] alpha_beta;   
}   
model {   
alpha_beta ~ multi_normal(mu,cov_m);   
deaths ~ binomial_logit(number_of_animals,alpha_beta[1]+alpha_beta[2]*doses);   
}   
"   

Total of 5 chains with 50000 samples were generated, from which 5000 burn-ins were removed. 
```{r, message=FALSE,results="hide"}
data<-list(n=length(bioassay$x),
           deaths=bioassay$y,
           number_of_animals=bioassay$n,
           doses=bioassay$x,
           mu=c(0,10),
           cov_m=matrix(c(4,10,10,100),ncol=2,nrow=2))
fit<-stan(file='bioassay_model.stan',data=data,iter=10000,warmup=1000,chains=5)
```
### 2)
Now we need to calculate $\hat{R}$:
$$\hat{R}=\sqrt{\frac{\hat{var^+(\theta|y)}}{W}}$$ with $\hat{var^+(\theta|y)}=\frac{N-1}{N}W+\frac{1}{N}B$
Where N is the number of fraws per chain, $B=Nvar(\overline{\theta_i})$ is the between chain variance where $\overline{\theta_i}$ is the mean of samples of each chain and $W=mean(\sigma_i^2)$ is the within chain variance where $\sigma_i^2$ is the variance of samples from each chain.\
After knowing the meaning of Rhat function, we can now try to inteprete it:
Because W is the within chain variance estimate, tends to underestimate the marginal posterior variance.On the other hand $\hat{var^+(\theta|y)}$ being the total variance estimate, tends to overestimate the marginal posteriorvariance. A $\hat{R}$ close to $1$ means that we have enough samples so the total variance is similar to the withinchain variance, in other words we are estimating with enough accuracy the marginal posterior variance.
The $\hat{R}$ values in my case are:
```{r}
fit_ss <- extract(fit, permuted = FALSE) 
alpha<-matrix(1:45000,nrow=9000,ncol=5)
for (i in seq(1,5,length=5)){
  alpha[,i]<-fit_ss[,i,1]
}
beta<-matrix(1:45000,nrow=9000,ncol=5)
for (i in seq(1,5,length=5)){
  beta[,i]<-fit_ss[,i,2]
}
```

```{r}
cat("the r hat value for alpha is: ",Rhat(alpha),'\n')
cat("the r hat value for beta is: ",Rhat(beta))
```

### 3)
The scatter plot is shown to see if the convergence is achieved. Compared it to the results in Figure 3.3b in BDA3, we can see that my results are sensible because they are similar. Note that the results in Figure 3.3b in BDA3 are generated from posterior with a uniform prior, so that it's fine if these 2 plots are a little bit different. 
```{r}
sim <- data.frame("alphas" = as.vector(t(alpha)), 
                  "betas" = as.vector(t(beta)),
                  "chain"=rep(1:5, 9000))
ggplot(sim,aes(x=alphas,y=betas)) +
  geom_point(aes(color = factor(chain)))+
  labs(title="scatter plot of alpha and beta generated by 5 chains of metropolis algorithm",
       x="alpha", y = "beta")
```
